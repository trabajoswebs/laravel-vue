app/ — código de aplicación organizado por capas
├── Application/ — casos de uso y contratos de aplicación
│   ├── Shared/Contracts/ — abstracciones compartidas
│   │   ├── AsyncJobDispatcherInterface.php — dispatcher de jobs encolados
│   │   ├── ClockInterface.php — reloj desacoplado para lógica/test
│   │   ├── EventBusInterface.php — bus de eventos de dominio/app
│   │   ├── LoggerInterface.php — logger agnóstico
│   │   ├── MetricsInterface.php — colector de métricas
│   │   ├── TenantContextInterface.php — acceso al tenant actual
│   │   └── TransactionManagerInterface.php — orquestador de transacciones
│   ├── Uploads/ — casos de uso de cargas
│   │   ├── Actions/
│   │   │   ├── ReplaceFile.php — reemplaza un upload existente
│   │   │   └── UploadFile.php — inicia una carga de archivo
│   │   ├── Contracts/
│   │   │   ├── UploadOrchestratorInterface.php — coordina pipeline de uploads
│   │   │   └── UploadRepositoryInterface.php — persistencia de uploads
│   │   └── DTO/
│   │       ├── ReplacementResult.php — resultado de reemplazo
│   │       └── UploadResult.php — resultado de carga
│   └── User/ — casos de uso de usuario/avatar
│       ├── Actions/
│       │   ├── DeleteAvatar.php — elimina avatar y limpia
│       │   └── UpdateAvatar.php — actualiza avatar del usuario
│       ├── Contracts/
│       │   ├── UserAvatarRepository.php — repositorio de avatar
│       │   └── UserRepository.php — repositorio de usuario
│       ├── DTO/
│       │   ├── AvatarDeletionResult.php — DTO borrado avatar
│       │   └── AvatarUpdateResult.php — DTO actualización avatar
│       ├── Events/
│       │   ├── AvatarDeleted.php — evento avatar eliminado
│       │   └── AvatarUpdated.php — evento avatar actualizado
│       └── Jobs/
│           ├── CleanupMediaArtifacts.php — job de limpieza de media
│           └── Enums/ConversionReadyState.php — enum estado de conversión
├── Console/
│   └── Kernel.php — agenda y registro de comandos artisan
├── Domain/ — objetos/valores/reglas de dominio
│   ├── Security/Rules/
│   │   ├── AvatarHeaderRules.php — validación de cabeceras avatar
│   │   └── RateLimitSignatureRules.php — reglas para firmas de rate limit
│   └── Uploads/
│       ├── ProcessingMode.php — enum modo de procesamiento
│       ├── ScanMode.php — enum modo de escaneo
│       ├── ServingMode.php — enum modo de entrega
│       ├── UploadKind.php — enum tipo de carga
│       ├── UploadProfile.php — perfil de upload (restricciones)
│       └── UploadProfileId.php — identificador de perfil
├── Infrastructure/ — adaptadores e implementaciones concretas
│   ├── Auth/Policies/ — autorizaciones
│   │   ├── Concerns/HandlesMediaOwnership.php — comprueba propiedad de media
│   │   ├── Concerns/HandlesTenantMembership.php — comprueba pertenencia a tenant
│   │   ├── UploadPolicy.php — políticas para uploads
│   │   └── UserPolicy.php — políticas para usuarios
│   ├── Console/
│   │   ├── Commands/
│   │   │   ├── CleanAuditLogs.php — limpia logs de auditoría
│   │   │   ├── QuarantineCleanupSidecarsCommand.php — limpia sidecars de cuarentena
│   │   │   ├── QuarantinePruneCommand.php — purga cuarentenas antiguas
│   │   │   └── TenancyBootstrapExistingUsers.php — inicializa tenancy para usuarios
│   │   └── Kernel.php — kernel de comandos infra
│   ├── Http/
│   │   ├── Controllers/
│   │   │   ├── Auth/ — flujo de autenticación
│   │   │   │   ├── AuthenticatedSessionController.php — login/logout
│   │   │   │   ├── ConfirmablePasswordController.php — confirmación de contraseña
│   │   │   │   ├── EmailVerificationNotificationController.php — envía correo de verificación
│   │   │   │   ├── EmailVerificationPromptController.php — muestra aviso de verificación
│   │   │   │   ├── NewPasswordController.php — reseteo con token
│   │   │   │   ├── PasswordResetLinkController.php — solicita enlace de reset
│   │   │   │   ├── RegisteredUserController.php — registro de usuarios
│   │   │   │   └── VerifyEmailController.php — confirma email
│   │   │   ├── Controller.php — base para controladores
│   │   │   ├── Health/HealthController.php — endpoint de salud
│   │   │   ├── LanguageController.php — cambio/estado de idioma
│   │   │   ├── Media/.gitkeep — marcador de directorio vacío
│   │   │   └── Settings/
│   │   │       ├── PasswordController.php — cambio de contraseña
│   │   │       └── ProfileController.php — edición de perfil
│   │   ├── Middleware/
│   │   │   ├── HandleAppearance.php — aplica tema/apariencia
│   │   │   ├── HandleInertiaRequests.php — integra Inertia y share globales
│   │   │   ├── PreventBruteForce.php — limita intentos de fuerza bruta
│   │   │   ├── SanitizeInput.php — sanitiza la entrada
│   │   │   ├── SecurityHeaders.php — cabeceras de seguridad
│   │   │   ├── TrustProxies.php — configura proxies de confianza
│   │   │   └── UserAudit.php — auditoría por solicitud/usuario
│   │   ├── Requests/
│   │   │   ├── Auth/LoginRequest.php — validación de login
│   │   │   ├── Concerns/SanitizesInputs.php — trait de normalización
│   │   │   └── Settings/ProfileUpdateRequest.php — validación de perfil
│   ├── Localization/TranslationService.php — carga y detecta traducciones
│   ├── Models/User.php — modelo Eloquent de usuario
│   ├── Providers/
│   │   ├── AppServiceProvider.php — bindings y boot genérico
│   │   ├── AuthServiceProvider.php — policies y gates
│   │   ├── EventServiceProvider.php — eventos/listeners
│   │   └── HtmlPurifierServiceProvider.php — configuración de purificador HTML
│   ├── Sanitization/DisplayName.php — sanitiza nombres visibles
│   ├── Security/
│   │   ├── AvatarHeaderInspector.php — valida cabeceras de imagen/avatar
│   │   ├── Exceptions/AntivirusException.php — error de antivirus
│   │   ├── RateLimitSignatureFactory.php — genera firmas de rate limit
│   │   └── SecurityHelper.php — utilidades de seguridad (hash, sanitize)
│   ├── Shared/
│   │   ├── Adapters/
│   │   │   ├── LaravelAsyncJobDispatcher.php — impl dispatcher de jobs
│   │   │   ├── LaravelClock.php — reloj basado en Laravel
│   │   │   ├── LaravelEventBus.php — bus de eventos con Laravel
│   │   │   ├── LaravelLogger.php — logger sobre el stack de Laravel
│   │   │   └── LaravelTransactionManager.php — transacciones DB
│   │   └── Metrics/LogMetrics.php — métricas via logs
│   ├── Tenancy/ — soporte multi-tenant
│   │   ├── Middleware/ResolveTenant.php — fija tenant en la request
│   │   ├── Models/Tenant.php — modelo de tenant
│   │   ├── Providers/TenancyServiceProvider.php — provider tenancy
│   │   ├── TenantContext.php — contexto tenant infraestructura
│   │   └── TenantFinder/AuthUserTenantFinder.php — encuentra tenant desde usuario auth
│   ├── Uploads/ — infraestructura de media/uploads
│   │   ├── README.md — guía de uploads
│   │   ├── Core/ — núcleo común de media
│   │   │   ├── Adapters/SpatieMediaResource.php — adapta recursos Spatie
│   │   │   ├── Contracts/
│   │   │   │   ├── FileConstraints.php
│   │   │   │   ├── MediaArtifactCollector.php
│   │   │   │   ├── MediaCleanupScheduler.php
│   │   │   │   ├── MediaOwner.php
│   │   │   │   ├── MediaProfile.php
│   │   │   │   ├── MediaResource.php
│   │   │   │   ├── MediaUploader.php
│   │   │   │   └── UploadedMedia.php
│   │   │   ├── DTO/
│   │   │   │   ├── CleanupStatePayload.php
│   │   │   │   ├── ConversionExpectations.php
│   │   │   │   ├── MediaReplacementItemSnapshot.php
│   │   │   │   ├── MediaReplacementResult.php
│   │   │   │   ├── MediaReplacementSnapshot.php
│   │   │   │   └── QueuedUploadResult.php
│   │   │   ├── Models/
│   │   │   │   ├── Concerns/TracksMediaVersions.php — tracking de versiones
│   │   │   │   ├── MediaCleanupState.php — estado de limpieza
│   │   │   │   └── Upload.php — modelo de upload
│   │   │   ├── Orchestrators/DefaultUploadOrchestrator.php — orquesta flujos
│   │   │   ├── Paths/
│   │   │   │   ├── MediaLibrary/TenantAwareFileNamer.php — nombres por tenant (Spatie)
│   │   │   │   ├── MediaLibrary/TenantAwarePathGenerator.php — rutas por tenant (Spatie)
│   │   │   │   ├── TenantPathGenerator.php — rutas genéricas por tenant
│   │   │   │   └── TenantPathLayout.php — compone la estructura física de rutas por tenant
│   │   │   ├── Registry/UploadProfileRegistry.php — catálogo de perfiles
│   │   │   ├── Repositories/EloquentUploadRepository.php — repo uploads
│   │   │   └── Services/MediaReplacementService.php — reemplazo de media
│   │   ├── Http/
│   │   │   ├── Controllers/
│   │   │   │   ├── DownloadUploadController.php — descarga un upload
│   │   │   │   ├── Media/ShowAvatar.php — sirve avatar almacenado
│   │   │   │   ├── Media/ShowMediaController.php — sirve media bajo token/tenant
│   │   │   │   ├── Settings/ProfileAvatarController.php — endpoints de avatar en settings
│   │   │   │   └── UploadController.php — carga genérica
│   │   │   ├── Middleware/
│   │   │   │   ├── RateLimitUploads.php — rate limit específico para uploads
│   │   │   │   └── TrackMediaAccess.php — auditoría de accesos
│   │   │   ├── Requests/
│   │   │   │   ├── Concerns/UsesDocumentValidation.php — reglas doc
│   │   │   │   ├── Concerns/UsesImageValidation.php — reglas imagen
│   │   │   │   ├── HttpUploadedMedia.php — adapta archivo HTTP a dominio
│   │   │   │   ├── ReplaceUploadRequest.php — valida reemplazo
│   │   │   │   ├── Settings/DeleteAvatarRequest.php — valida borrado avatar
│   │   │   │   ├── Settings/UpdateAvatarRequest.php — valida update avatar
│   │   │   │   ├── StoreUploadRequest.php — valida alta upload
│   │   │   │   └── UploadImageRequest.php — valida imagen
│   │   │   ├── Rules/SecureImageValidation.php — regla compuesta para imágenes
│   │   │   └── Support/MediaServingResponder.php — centraliza respuestas HTTP para servir media
│   │   ├── Pipeline/ — pipelines y seguridad de media
│   │   │   ├── Contracts/UploadMetadata.php
│   │   │   ├── Contracts/UploadPipeline.php
│   │   │   ├── Contracts/UploadResult.php
│   │   │   ├── Contracts/UploadService.php
│   │   │   ├── DTO/InternalPipelineResult.php
│   │   │   ├── DefaultUploadPipeline.php
│   │   │   ├── DefaultUploadService.php
│   │   │   ├── Exceptions/NormalizationFailedException.php
│   │   │   ├── Exceptions/QuarantineException.php
│   │   │   ├── Exceptions/QuarantineIntegrityException.php
│   │   │   ├── Exceptions/ScanFailedException.php
│   │   │   ├── Exceptions/UnexpectedUploadException.php
│   │   │   ├── Exceptions/UploadException.php
│   │   │   ├── Exceptions/UploadValidationException.php
│   │   │   ├── Exceptions/VirusDetectedException.php
│   │   │   ├── Health/UploadPipelineHealthCheck.php — health del pipeline
│   │   │   ├── Image/ — pipeline de imágenes
│   │   │   │   ├── AvatarConversionProfile.php
│   │   │   │   ├── Concerns/GuardsUploadedImage.php
│   │   │   │   ├── FallbackWorkflow.php
│   │   │   │   ├── ImagePipeline.php
│   │   │   │   ├── ImagePipelineResult.php
│   │   │   │   ├── ImageProcessingException.php
│   │   │   │   ├── ImagickWorkflow.php
│   │   │   │   ├── PipelineArtifacts.php
│   │   │   │   ├── PipelineConfig.php
│   │   │   │   └── PipelineLogger.php
│   │   │   ├── ImageUploadPipelineAdapter.php — adapta pipeline imágenes a interfaz base
│   │   │   ├── Jobs/
│   │   │   │   ├── CleanupAvatarOrphans.php — limpia avatares huérfanos
│   │   │   │   ├── CleanupMediaArtifactsJob.php — limpieza de artefactos
│   │   │   │   ├── PerformConversionsJob.php — ejecuta conversiones pendientes
│   │   │   │   ├── PostProcessAvatarMedia.php — post-procesa avatar
│   │   │   │   ├── ProcessLatestAvatar.php — procesa el último avatar pendiente
│   │   │   │   └── ProcessUploadJob.php — procesa una carga
│   │   │   ├── Listeners/QueueAvatarPostProcessing.php — encola post-proceso avatar
│   │   │   ├── Listeners/RunPendingMediaCleanup.php — encola limpieza pendiente
│   │   │   ├── Observers/MediaObserver.php — hooks de modelo media
│   │   │   ├── Optimizer/
│   │   │   │   ├── Adapters/LocalOptimizationAdapter.php — optimiza local
│   │   │   │   ├── Adapters/RemoteDownloader.php — baja para optimización remota
│   │   │   │   ├── Adapters/RemoteUploader.php — sube luego de optimizar
│   │   │   │   └── OptimizerService.php — orquestador de optimización
│   │   │   ├── Quarantine/
│   │   │   │   ├── LocalQuarantineRepository.php — cuarentena en disco
│   │   │   │   ├── QuarantineRepository.php — contrato de cuarentena
│   │   │   │   ├── QuarantineState.php — estado de cuarentena
│   │   │   │   └── QuarantineToken.php — token de seguimiento
│   │   │   ├── Scanning/
│   │   │   │   ├── GitYaraRuleManager.php — gestiona reglas Yara desde git
│   │   │   │   ├── ScanCoordinator.php — orquesta escaneos
│   │   │   │   ├── ScanCoordinatorInterface.php — contrato de coordinador
│   │   │   │   ├── Scanners/AbstractScanner.php — base para escáneres
│   │   │   │   ├── Scanners/ClamAvScanner.php — escaneo con ClamAV
│   │   │   │   ├── Scanners/YaraScanner.php — escaneo con Yara
│   │   │   │   └── YaraRuleManager.php — administra reglas Yara locales
│   │   │   ├── Security/
│   │   │   │   ├── Exceptions/InvalidRuleException.php — error de regla
│   │   │   │   ├── ImageMetadataReader.php — lee metadatos EXIF
│   │   │   │   ├── ImageNormalizer.php — normaliza imágenes
│   │   │   │   ├── Logging/MediaLogSanitizer.php — sanea datos sensibles antes de loguear
│   │   │   │   ├── Logging/MediaSecurityLogger.php — logger de eventos de seguridad en media
│   │   │   │   ├── MagicBytesValidator.php — valida magic bytes
│   │   │   │   ├── MimeNormalizer.php — normaliza MIME
│   │   │   │   ├── PayloadScanner.php — escanea payload
│   │   │   │   ├── Upload/UploadSecurityLogger.php — logging de seguridad
│   │   │   │   └── Upload/UploadValidationLogger.php — logging de validaciones
│   │   │   ├── Services/MediaCleanupScheduler.php — agenda limpiezas
│   │   │   ├── Support/ImageUploadReporter.php — reporter de imagen
│   │   │   ├── Support/MediaArtifactCollector.php — recolector de artefactos
│   │   │   ├── Support/MediaCleanupArtifactsBuilder.php — construye lotes de artefactos para limpieza
│   │   │   ├── Support/PipelineResultMapper.php — mapea resultados
│   │   │   └── Support/QuarantineManager.php — gestiona cuarentenas
│   │   ├── Profiles/
│   │   │   ├── AvatarImageProfile.php — perfil imagen avatar
│   │   │   ├── AvatarProfile.php — perfil avatar general
│   │   │   ├── CertificateSecretProfile.php — perfil para certificados
│   │   │   ├── DocumentPdfProfile.php — perfil PDFs
│   │   │   ├── GalleryImageProfile.php — perfil imágenes galería
│   │   │   ├── GalleryProfile.php — perfil galería mixta
│   │   │   ├── ImportCsvProfile.php — perfil CSV import
│   │   │   └── SpreadsheetXlsxProfile.php — perfil XLSX
│   │   └── Providers/
│   │       ├── ImagePipelineServiceProvider.php — provider pipeline
│   │       ├── MediaLibraryBindingsServiceProvider.php — bindings Spatie
│   │       └── UploadsServiceProvider.php — provider general uploads
│   ├── User/ — integraciones de usuario/avatar
│   │   ├── Adapters/
│   │   │   ├── EloquentUserAvatarRepository.php — persistencia de avatares
│   │   │   └── EloquentUserRepository.php — persistencia de usuarios
│   │   └── Listeners/
│   │       ├── OnAvatarDeleted.php — reacciona al evento AvatarDeleted
│   │       └── OnAvatarUpdated.php — reacciona al evento AvatarUpdated
├── Support/ — utilidades compartidas
│   ├── Logging/SecurityLogger.php — logger genérico para eventos de seguridad
│   └── Media/TenantAwareUrlGenerator.php — genera URLs de media por tenant
└── README.md — guía raíz de la capa app
